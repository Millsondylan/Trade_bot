// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YourTradingBot

//@version=5
indicator("Buy/Sell Pressure Deep Candles", shorttitle="Pressure Candles", overlay=true, max_bars_back=500)

// ============================================================================
// PARAMETERS
// ============================================================================

// Display Options
pressureType = input.string("Delta Candles", "Pressure Display Type",
     options=["Delta Candles", "Split Bars", "Pressure Histogram", "Heatmap Candles"])
showTraditionalCandles = input.bool(false, "Show Traditional Candles Too")
showVolumeProfile = input.bool(true, "Show Volume Profile")

// Calculation Method
calcMethod = input.string("Weighted", "Calculation Method",
     options=["Simple", "Weighted", "Advanced"])

// Colors
bullPressureColor = input.color(color.new(#00ff00, 0), "Strong Buy Pressure")
weakBullColor = input.color(color.new(#00ff00, 60), "Weak Buy Pressure")
bearPressureColor = input.color(color.new(#ff0000, 0), "Strong Sell Pressure")
weakBearColor = input.color(color.new(#ff0000, 60), "Weak Sell Pressure")
neutralColor = input.color(color.new(#888888, 40), "Neutral")

// Volume Profile Settings
profileBars = input.int(20, "Volume Profile Bars", minval=5, maxval=100)
profileWidth = input.float(1.5, "Profile Width Multiplier", minval=0.5, maxval=5.0)

// ============================================================================
// BUYING AND SELLING PRESSURE CALCULATION
// ============================================================================

// Method 1: Simple (Volume split by candle color)
calcSimplePressure() =>
    buyVol = close > open ? volume : 0.0
    sellVol = close < open ? volume : 0.0
    neutralVol = close == open ? volume : 0.0
    [buyVol, sellVol, neutralVol]

// Method 2: Weighted (Uses wick analysis)
calcWeightedPressure() =>
    range = high - low

    if range == 0
        [volume / 2, volume / 2, 0.0]
    else
        // Body size relative to total range
        bodySize = math.abs(close - open)
        bodyPercent = bodySize / range

        // Upper and lower wick analysis
        upperWick = close > open ? (high - close) : (high - open)
        lowerWick = close > open ? (open - low) : (close - low)

        upperWickPercent = upperWick / range
        lowerWickPercent = lowerWick / range

        // Distribute volume based on price movement within candle
        if close > open  // Bullish candle
            // More buying pressure
            buyVol = volume * (0.5 + (bodyPercent * 0.3) + (lowerWickPercent * 0.2))
            sellVol = volume * (0.5 - (bodyPercent * 0.3) - (upperWickPercent * 0.2))
        else if close < open  // Bearish candle
            // More selling pressure
            sellVol = volume * (0.5 + (bodyPercent * 0.3) + (upperWickPercent * 0.2))
            buyVol = volume * (0.5 - (bodyPercent * 0.3) - (lowerWickPercent * 0.2))
        else  // Doji
            buyVol = volume * (0.5 + (lowerWickPercent * 0.2))
            sellVol = volume * (0.5 + (upperWickPercent * 0.2))

        [math.max(buyVol, 0), math.max(sellVol, 0), 0.0]

// Method 3: Advanced (Intrabar volume distribution estimation)
calcAdvancedPressure() =>
    range = high - low

    if range == 0
        [volume / 2, volume / 2, 0.0]
    else
        // Calculate where close is relative to high/low (0-1)
        closePosition = (close - low) / range

        // Estimate buying/selling based on:
        // 1. Close position in range (higher = more buying)
        // 2. Body direction and size
        // 3. Wick proportions

        bodyMid = (open + close) / 2
        bodyMidPosition = (bodyMid - low) / range

        // Volume distribution weights
        closeWeight = closePosition  // Where price ended up
        bodyWeight = close > open ? 0.7 : 0.3  // Body direction

        // Combined buying pressure estimate
        buyPressure = (closeWeight * 0.6) + (bodyWeight * 0.4)
        sellPressure = 1 - buyPressure

        buyVol = volume * buyPressure
        sellVol = volume * sellPressure

        [buyVol, sellVol, 0.0]

// Select calculation method
[buyVolume, sellVolume, neutralVolume] = switch calcMethod
    "Simple" => calcSimplePressure()
    "Weighted" => calcWeightedPressure()
    "Advanced" => calcAdvancedPressure()
    => calcSimplePressure()

// Calculate delta (buying - selling pressure)
delta = buyVolume - sellVolume
deltaPct = volume > 0 ? (delta / volume) * 100 : 0

// Cumulative delta
var float cumDelta = 0
cumDelta := cumDelta + delta

// Normalize delta for coloring (-100 to +100)
normDelta = deltaPct

// ============================================================================
// PRESSURE STRENGTH CLASSIFICATION
// ============================================================================

getStrength(delta) =>
    absDelta = math.abs(delta)
    if absDelta > 70
        "Strong"
    else if absDelta > 40
        "Moderate"
    else if absDelta > 15
        "Weak"
    else
        "Neutral"

strength = getStrength(normDelta)

// Color based on delta strength
getPressureColor(delta) =>
    if delta > 70
        bullPressureColor
    else if delta > 15
        weakBullColor
    else if delta < -70
        bearPressureColor
    else if delta < -15
        weakBearColor
    else
        neutralColor

candleColor = getPressureColor(normDelta)

// ============================================================================
// VISUALIZATION: DELTA CANDLES
// ============================================================================

if pressureType == "Delta Candles"
    // Draw candles colored by buying/selling pressure
    plotcandle(open, high, low, close,
         title="Pressure Candles",
         color=candleColor,
         wickcolor=candleColor,
         bordercolor=candleColor)

// ============================================================================
// VISUALIZATION: SPLIT BARS (Buy/Sell Separated)
// ============================================================================

if pressureType == "Split Bars"
    // Calculate bar positioning
    barWidth = (time - time[1]) * 0.4

    // Plot buy volume bar (left side)
    buyHeight = (high - low) * (buyVolume / volume)
    plot(low + buyHeight, color=na, style=plot.style_line)

    // Plot sell volume bar (right side)
    sellHeight = (high - low) * (sellVolume / volume)
    plot(low + sellHeight, color=na, style=plot.style_line)

    // Box visualization would go here (requires box drawing in loop)
    // Using candles as approximation
    plotcandle(open, low + buyHeight, low, low + buyHeight,
         title="Buy Pressure",
         color=color.new(bullPressureColor, 30),
         wickcolor=color.new(bullPressureColor, 30))

// ============================================================================
// VISUALIZATION: PRESSURE HISTOGRAM
// ============================================================================

if pressureType == "Pressure Histogram"
    // Plot delta as histogram overlay
    plot(close + (delta / volume * (high - low)),
         title="Delta Line",
         color=candleColor,
         linewidth=3,
         style=plot.style_histogram)

    // Still show candles underneath
    plotcandle(open, high, low, close,
         title="Base Candles",
         color=color.new(color.gray, 70),
         wickcolor=color.new(color.gray, 70))

// ============================================================================
// VISUALIZATION: HEATMAP CANDLES
// ============================================================================

if pressureType == "Heatmap Candles"
    // Create color gradient based on delta
    heatmapColor = normDelta > 0 ?
         color.from_gradient(normDelta, 0, 100, weakBullColor, bullPressureColor) :
         color.from_gradient(normDelta, -100, 0, bearPressureColor, weakBearColor)

    plotcandle(open, high, low, close,
         title="Heatmap Candles",
         color=heatmapColor,
         wickcolor=heatmapColor,
         bordercolor=heatmapColor)

// ============================================================================
// OPTIONAL: SHOW TRADITIONAL CANDLES FOR COMPARISON
// ============================================================================

if showTraditionalCandles
    plotcandle(open, high, low, close,
         title="Traditional",
         color=close > open ? color.new(color.green, 80) : color.new(color.red, 80),
         wickcolor=color.gray,
         bordercolor=color.gray)

// ============================================================================
// VOLUME PROFILE (HORIZONTAL VOLUME AT PRICE)
// ============================================================================

if showVolumeProfile and barstate.islast
    // Calculate volume profile for last N bars
    var float[] priceLevels = array.new_float(0)
    var float[] volumeLevels = array.new_float(0)

    // Simple volume profile (10 price levels)
    levels = 10
    lookback = math.min(profileBars, bar_index)

    // Calculate price range
    highestPrice = ta.highest(high, lookback)
    lowestPrice = ta.lowest(low, lookback)
    priceRange = highestPrice - lowestPrice
    levelSize = priceRange / levels

    // Note: Full volume profile requires array operations in loop
    // TradingView limits make this challenging in overlay mode
    // This is a simplified representation

// ============================================================================
// INFORMATION TABLE
// ============================================================================

var table infoTable = table.new(position.top_right, 3, 6,
     bgcolor=color.new(color.black, 85),
     border_width=1,
     border_color=color.gray)

if barstate.islast
    // Headers
    table.cell(infoTable, 0, 0, "Metric",
         text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    table.cell(infoTable, 1, 0, "Current",
         text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    table.cell(infoTable, 2, 0, "Strength",
         text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))

    // Buy Volume
    table.cell(infoTable, 0, 1, "Buy Vol", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(math.round(buyVolume)),
         text_color=bullPressureColor, text_size=size.small)
    table.cell(infoTable, 2, 1, str.tostring(math.round((buyVolume/volume)*100)) + "%",
         text_color=color.white, text_size=size.small)

    // Sell Volume
    table.cell(infoTable, 0, 2, "Sell Vol", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(math.round(sellVolume)),
         text_color=bearPressureColor, text_size=size.small)
    table.cell(infoTable, 2, 2, str.tostring(math.round((sellVolume/volume)*100)) + "%",
         text_color=color.white, text_size=size.small)

    // Delta
    table.cell(infoTable, 0, 3, "Delta", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(math.round(delta)),
         text_color=candleColor, text_size=size.small)
    table.cell(infoTable, 2, 3, str.tostring(math.round(deltaPct)) + "%",
         text_color=candleColor, text_size=size.small)

    // Cumulative Delta
    table.cell(infoTable, 0, 4, "Cum Delta", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(math.round(cumDelta)),
         text_color=cumDelta > 0 ? bullPressureColor : bearPressureColor, text_size=size.small)
    table.cell(infoTable, 2, 4, strength,
         text_color=color.white, text_size=size.small)

    // Total Volume
    table.cell(infoTable, 0, 5, "Volume", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(math.round(volume)),
         text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 2, 5, "", text_color=color.white, text_size=size.small)

// ============================================================================
// PLOTS FOR SEPARATE PANEL (Optional)
// ============================================================================

// Uncomment these if you want delta in separate panel
// plot(delta, "Delta", color=candleColor, linewidth=2)
// plot(cumDelta, "Cumulative Delta", color=color.yellow, linewidth=1)
// hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)

// ============================================================================
// ALERTS
// ============================================================================

// Strong buying pressure
alertcondition(normDelta > 70,
     title="Strong Buying Pressure",
     message="Strong buying pressure detected: {{ticker}} - Delta: {{plot_0}}")

// Strong selling pressure
alertcondition(normDelta < -70,
     title="Strong Selling Pressure",
     message="Strong selling pressure detected: {{ticker}} - Delta: {{plot_0}}")

// Delta divergence (price down but buying pressure)
bullishDivergence = close < close[1] and delta > 0 and delta > delta[1]
alertcondition(bullishDivergence,
     title="Bullish Pressure Divergence",
     message="Bullish divergence: Price falling but buying pressure increasing on {{ticker}}")

// Delta divergence (price up but selling pressure)
bearishDivergence = close > close[1] and delta < 0 and delta < delta[1]
alertcondition(bearishDivergence,
     title="Bearish Pressure Divergence",
     message="Bearish divergence: Price rising but selling pressure increasing on {{ticker}}")
