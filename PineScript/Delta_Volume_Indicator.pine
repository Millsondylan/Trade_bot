// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YourTradingBot

//@version=5
indicator("Delta Volume & Pressure Analysis", shorttitle="Delta Vol", overlay=false)

// ============================================================================
// PARAMETERS
// ============================================================================

// Calculation Settings
showBuySell = input.bool(true, "Show Buy/Sell Volume Bars")
showDelta = input.bool(true, "Show Delta Line")
showCumDelta = input.bool(true, "Show Cumulative Delta")
showDeltaMA = input.bool(true, "Show Delta Moving Average")
maLength = input.int(20, "Delta MA Length", minval=1)

// Volume Analysis
volMethod = input.string("Advanced", "Volume Analysis Method",
     options=["Simple", "Weighted", "Advanced"])
normalizeVol = input.bool(true, "Normalize Volume (0-100)")

// Colors
buyColor = input.color(color.new(#00ff00, 20), "Buy Volume")
sellColor = input.color(color.new(#ff0000, 20), "Sell Volume")
deltaUpColor = input.color(#00ff00, "Delta Positive")
deltaDownColor = input.color(#ff0000, "Delta Negative")
cumDeltaColor = input.color(#ffaa00, "Cumulative Delta")
maColor = input.color(#00aaff, "Delta MA")

// ============================================================================
// VOLUME PRESSURE CALCULATIONS
// ============================================================================

calcBuySellVolume(method) =>
    var float buy = 0.0
    var float sell = 0.0

    if method == "Simple"
        // Simple: Green candle = buy, red = sell
        buy := close > open ? volume : 0.0
        sell := close < open ? volume : 0.0

    else if method == "Weighted"
        // Weighted: Consider wicks and body size
        range = high - low
        if range > 0
            closePos = (close - low) / range
            bodySize = math.abs(close - open) / range

            // More sophisticated split
            if close > open
                buy := volume * (0.5 + (closePos * 0.3) + (bodySize * 0.2))
                sell := volume - buy
            else if close < open
                sell := volume * (0.5 + ((1 - closePos) * 0.3) + (bodySize * 0.2))
                buy := volume - sell
            else
                buy := volume * closePos
                sell := volume * (1 - closePos)
        else
            buy := volume * 0.5
            sell := volume * 0.5

    else  // Advanced
        // Advanced: Estimate intrabar pressure
        range = high - low
        if range > 0
            // Where did price close relative to range?
            closePos = (close - low) / range

            // Was there a decisive move?
            bodySize = math.abs(close - open)
            bodyPct = bodySize / range

            // Upper and lower wick analysis
            upperWick = math.max(high - close, high - open)
            lowerWick = math.max(close - low, open - low)
            upperWickPct = upperWick / range
            lowerWickPct = lowerWick / range

            // Combine factors
            // Higher close position = more buying
            // Larger body = more conviction
            // Lower wick rejection = buying support
            buyScore = (closePos * 0.5) + (bodyPct * 0.3 * (close > open ? 1 : 0)) + (lowerWickPct * 0.2)
            buyScore := math.min(math.max(buyScore, 0), 1)

            buy := volume * buyScore
            sell := volume * (1 - buyScore)
        else
            buy := volume * 0.5
            sell := volume * 0.5

    [buy, sell]

[buyVol, sellVol] = calcBuySellVolume(volMethod)

// Delta calculation
delta = buyVol - sellVol

// Cumulative delta
var float cumDelta = 0.0
cumDelta := cumDelta + delta

// Delta moving average (trend)
deltaMA = ta.sma(delta, maLength)

// Normalize if requested (percentage of total volume)
displayBuyVol = normalizeVol ? (buyVol / volume * 100) : buyVol
displaySellVol = normalizeVol ? (sellVol / volume * 100) : sellVol
displayDelta = normalizeVol ? (delta / volume * 100) : delta

// ============================================================================
// VOLUME IMBALANCE DETECTION
// ============================================================================

// Significant imbalance (>70% in one direction)
strongBuyImbalance = (buyVol / volume) > 0.70
strongSellImbalance = (sellVol / volume) > 0.70

// Volume spike with imbalance
avgVol = ta.sma(volume, 20)
volSpike = volume > avgVol * 1.5

criticalBuySignal = strongBuyImbalance and volSpike
criticalSellSignal = strongSellImbalance and volSpike

// Cumulative delta divergence
priceTrend = close - close[10]
cumDeltaTrend = cumDelta - cumDelta[10]

bullishDivergence = priceTrend < 0 and cumDeltaTrend > 0  // Price down, buying up
bearishDivergence = priceTrend > 0 and cumDeltaTrend < 0  // Price up, selling up

// ============================================================================
// PLOTTING
// ============================================================================

// Buy and Sell volume bars
if showBuySell
    plot(displayBuyVol, "Buy Volume", color=buyColor, style=plot.style_columns, linewidth=3)
    plot(-displaySellVol, "Sell Volume", color=sellColor, style=plot.style_columns, linewidth=3)

// Delta line
if showDelta
    deltaColor = delta > 0 ? deltaUpColor : deltaDownColor
    plot(displayDelta, "Delta", color=deltaColor, linewidth=2, style=plot.style_line)

// Cumulative delta
if showCumDelta
    plot(cumDelta, "Cumulative Delta", color=cumDeltaColor, linewidth=2)

// Delta moving average
if showDeltaMA
    plot(deltaMA, "Delta MA", color=maColor, linewidth=1, style=plot.style_line)

// Zero line
hline(0, "Zero", color=color.new(color.gray, 50), linestyle=hline.style_dashed)

// ============================================================================
// BACKGROUND HIGHLIGHTING
// ============================================================================

// Highlight critical imbalances
bgcolor(criticalBuySignal ? color.new(color.green, 90) : na, title="Strong Buy Pressure")
bgcolor(criticalSellSignal ? color.new(color.red, 90) : na, title="Strong Sell Pressure")

// Highlight divergences
bgcolor(bullishDivergence ? color.new(color.green, 95) : na, title="Bullish Divergence")
bgcolor(bearishDivergence ? color.new(color.red, 95) : na, title="Bearish Divergence")

// ============================================================================
// LABELS FOR CRITICAL SIGNALS
// ============================================================================

if criticalBuySignal and barstate.isconfirmed
    label.new(bar_index, displayDelta, "ðŸ”¥ BUY",
         style=label.style_label_up,
         color=color.new(color.green, 0),
         textcolor=color.white,
         size=size.small)

if criticalSellSignal and barstate.isconfirmed
    label.new(bar_index, displayDelta, "ðŸ”¥ SELL",
         style=label.style_label_down,
         color=color.new(color.red, 0),
         textcolor=color.white,
         size=size.small)

if bullishDivergence and barstate.isconfirmed
    label.new(bar_index, displayDelta, "ðŸ“ˆ DIV",
         style=label.style_label_up,
         color=color.new(color.blue, 0),
         textcolor=color.white,
         size=size.tiny)

if bearishDivergence and barstate.isconfirmed
    label.new(bar_index, displayDelta, "ðŸ“‰ DIV",
         style=label.style_label_down,
         color=color.new(color.orange, 0),
         textcolor=color.white,
         size=size.tiny)

// ============================================================================
// STATISTICS TABLE
// ============================================================================

var table statsTable = table.new(position.top_right, 2, 7,
     bgcolor=color.new(color.black, 85),
     border_width=1,
     border_color=color.gray)

if barstate.islast
    // Headers
    table.cell(statsTable, 0, 0, "Metric", text_color=color.white, text_size=size.small,
         bgcolor=color.new(color.blue, 70))
    table.cell(statsTable, 1, 0, "Value", text_color=color.white, text_size=size.small,
         bgcolor=color.new(color.blue, 70))

    // Buy Volume %
    buyPct = (buyVol / volume) * 100
    table.cell(statsTable, 0, 1, "Buy %", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 1, str.tostring(math.round(buyPct, 1)) + "%",
         text_color=buyColor, text_size=size.small)

    // Sell Volume %
    sellPct = (sellVol / volume) * 100
    table.cell(statsTable, 0, 2, "Sell %", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 2, str.tostring(math.round(sellPct, 1)) + "%",
         text_color=sellColor, text_size=size.small)

    // Delta
    table.cell(statsTable, 0, 3, "Delta", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 3, str.tostring(math.round(delta)),
         text_color=delta > 0 ? deltaUpColor : deltaDownColor, text_size=size.small)

    // Cum Delta
    table.cell(statsTable, 0, 4, "Cum Î”", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 4, str.tostring(math.round(cumDelta)),
         text_color=cumDeltaColor, text_size=size.small)

    // Volume vs Avg
    volVsAvg = (volume / avgVol - 1) * 100
    table.cell(statsTable, 0, 5, "Vol vs Avg", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 5, str.tostring(math.round(volVsAvg, 1)) + "%",
         text_color=volVsAvg > 50 ? color.yellow : color.gray, text_size=size.small)

    // Pressure strength
    pressureStr = buyPct > 70 ? "STRONG BUY" : sellPct > 70 ? "STRONG SELL" : "BALANCED"
    pressureColor = buyPct > 70 ? buyColor : sellPct > 70 ? sellColor : color.gray
    table.cell(statsTable, 0, 6, "Pressure", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 6, pressureStr, text_color=pressureColor, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(criticalBuySignal, "Critical Buy Pressure",
     "Critical buying pressure on {{ticker}}: {{plot_0}}%")

alertcondition(criticalSellSignal, "Critical Sell Pressure",
     "Critical selling pressure on {{ticker}}: {{plot_0}}%")

alertcondition(bullishDivergence, "Bullish Divergence",
     "Bullish divergence detected on {{ticker}}: Price falling but buying increasing")

alertcondition(bearishDivergence, "Bearish Divergence",
     "Bearish divergence detected on {{ticker}}: Price rising but selling increasing")

// ============================================================================
// PLOT OUTPUTS (for use in other scripts/alerts)
// ============================================================================

plot(buyPct, "Buy Percent", display=display.none)
plot(sellPct, "Sell Percent", display=display.none)
plot(delta, "Delta Value", display=display.none)
