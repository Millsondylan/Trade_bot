// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YourTradingBot - BEST Buy/Sell Pressure Indicator

//@version=5
indicator("Buy/Sell Pressure Deep Charts", shorttitle="Pressure", overlay=true, max_bars_back=500)

// ============================================================================
// SIMPLE SETTINGS - JUST WHAT YOU NEED
// ============================================================================

colorMode = input.string("Pressure Candles", "Display Mode",
     options=["Pressure Candles", "Traditional + Pressure Info"])
showStats = input.bool(true, "Show Statistics Panel")

// ============================================================================
// ACCURATE VOLUME PRESSURE CALCULATION
// ============================================================================

// Most accurate method: Analyzes candle structure + volume distribution
calculatePressure() =>
    float buyVol = 0.0
    float sellVol = 0.0

    // Get candle metrics
    _open = open
    _high = high
    _low = low
    _close = close
    _volume = volume
    _range = _high - _low

    // Handle zero range (flat candle)
    if _range == 0
        buyVol := _volume / 2
        sellVol := _volume / 2
        [buyVol, sellVol]
    else
        // WHERE DID PRICE CLOSE IN THE RANGE? (0 = bottom, 1 = top)
        closePosition = (_close - _low) / _range

        // HOW BIG WAS THE BODY?
        bodySize = math.abs(_close - _open)
        bodyPercent = bodySize / _range

        // WICK ANALYSIS
        // Large lower wick = buyers rejected low prices (bullish)
        // Large upper wick = sellers rejected high prices (bearish)
        upperWick = _high - math.max(_open, _close)
        lowerWick = math.min(_open, _close) - _low
        upperWickPercent = upperWick / _range
        lowerWickPercent = lowerWick / _range

        // BULLISH OR BEARISH CANDLE?
        isBullish = _close > _open
        isBearish = _close < _open

        // CALCULATE BUY PRESSURE SCORE (0 to 1)
        // Higher score = more buying
        float pressureScore = 0.5  // Start neutral

        // Factor 1: Close position (50% weight)
        // Close near high = buying, close near low = selling
        pressureScore := pressureScore + ((closePosition - 0.5) * 0.50)

        // Factor 2: Body direction (25% weight)
        // Green candle adds buying pressure, red adds selling
        if isBullish
            pressureScore := pressureScore + (bodyPercent * 0.25)
        else if isBearish
            pressureScore := pressureScore - (bodyPercent * 0.25)

        // Factor 3: Wick rejection (25% weight)
        // Lower wick = buyers defended low (bullish)
        // Upper wick = sellers defended high (bearish)
        wickPressure = lowerWickPercent - upperWickPercent
        pressureScore := pressureScore + (wickPressure * 0.25)

        // Clamp between 0 and 1
        pressureScore := math.max(0, math.min(1, pressureScore))

        // SPLIT VOLUME
        buyVol := _volume * pressureScore
        sellVol := _volume * (1 - pressureScore)

        [buyVol, sellVol]

// Calculate buy and sell volume
[buyVolume, sellVolume] = calculatePressure()

// Delta = Net pressure
delta = buyVolume - sellVolume

// Delta as percentage of total volume
deltaPercent = volume > 0 ? (delta / volume) * 100 : 0

// Cumulative Delta (institutional footprint)
var float cumulativeDelta = 0
cumulativeDelta := cumulativeDelta + delta

// Buy and Sell percentages
buyPercent = volume > 0 ? (buyVolume / volume) * 100 : 50
sellPercent = volume > 0 ? (sellVolume / volume) * 100 : 50

// ============================================================================
// PRESSURE STRENGTH CLASSIFICATION
// ============================================================================

// Classify pressure strength
getStrength() =>
    if buyPercent > 75
        "VERY STRONG BUY"
    else if buyPercent > 65
        "STRONG BUY"
    else if buyPercent > 55
        "WEAK BUY"
    else if sellPercent > 75
        "VERY STRONG SELL"
    else if sellPercent > 65
        "STRONG SELL"
    else if sellPercent > 55
        "WEAK SELL"
    else
        "BALANCED"

strength = getStrength()

// Color based on pressure
getColor() =>
    if buyPercent > 75
        color.new(#00ff00, 0)  // Bright green
    else if buyPercent > 65
        color.new(#00ff00, 30)  // Green
    else if buyPercent > 55
        color.new(#00ff00, 60)  // Light green
    else if sellPercent > 75
        color.new(#ff0000, 0)  // Bright red
    else if sellPercent > 65
        color.new(#ff0000, 30)  // Red
    else if sellPercent > 55
        color.new(#ff0000, 60)  // Light red
    else
        color.new(#999999, 50)  // Gray

pressureColor = getColor()

// ============================================================================
// VISUALIZATION
// ============================================================================

// Determine candle colors based on mode
candleColor = colorMode == "Pressure Candles" ? pressureColor :
     (close > open ? color.new(#26a69a, 0) : color.new(#ef5350, 0))

// Plot candles (must be at root level, not in if statement)
plotcandle(open, high, low, close,
     title="Candles",
     color=candleColor,
     wickcolor=candleColor,
     bordercolor=candleColor)

// ============================================================================
// STATISTICS PANEL
// ============================================================================

if showStats
    var table statsTable = table.new(position.top_right, 2, 8,
         bgcolor=color.new(#000000, 15),
         border_width=2,
         border_color=color.new(#333333, 0),
         frame_width=1,
         frame_color=color.new(#666666, 0))

    if barstate.islast
        // Title
        table.cell(statsTable, 0, 0, "BUY/SELL PRESSURE",
             text_color=color.white,
             text_size=size.normal,
             bgcolor=color.new(#1e88e5, 20),
             text_halign=text.align_center)
        table.merge_cells(statsTable, 0, 0, 1, 0)

        // Current candle header
        table.cell(statsTable, 0, 1, "CURRENT BAR",
             text_color=color.new(#ffffff, 30),
             text_size=size.small,
             bgcolor=color.new(#333333, 50),
             text_halign=text.align_center)
        table.merge_cells(statsTable, 0, 1, 1, 1)

        // Buy Volume
        table.cell(statsTable, 0, 2, "Buy Volume:",
             text_color=color.new(#ffffff, 40),
             text_size=size.small,
             text_halign=text.align_left)
        table.cell(statsTable, 1, 2, str.tostring(math.round(buyPercent, 1)) + "%",
             text_color=color.new(#00ff00, 0),
             text_size=size.normal,
             text_halign=text.align_right)

        // Sell Volume
        table.cell(statsTable, 0, 3, "Sell Volume:",
             text_color=color.new(#ffffff, 40),
             text_size=size.small,
             text_halign=text.align_left)
        table.cell(statsTable, 1, 3, str.tostring(math.round(sellPercent, 1)) + "%",
             text_color=color.new(#ff0000, 0),
             text_size=size.normal,
             text_halign=text.align_right)

        // Delta
        table.cell(statsTable, 0, 4, "Delta:",
             text_color=color.new(#ffffff, 40),
             text_size=size.small,
             text_halign=text.align_left)
        deltaColor = deltaPercent > 0 ? color.new(#00ff00, 0) : color.new(#ff0000, 0)
        deltaSign = deltaPercent > 0 ? "+" : ""
        table.cell(statsTable, 1, 4, deltaSign + str.tostring(math.round(deltaPercent, 1)) + "%",
             text_color=deltaColor,
             text_size=size.normal,
             text_halign=text.align_right)

        // Divider
        table.cell(statsTable, 0, 5, "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",
             text_color=color.new(#666666, 0),
             text_size=size.small,
             text_halign=text.align_center)
        table.merge_cells(statsTable, 0, 5, 1, 5)

        // Cumulative Delta
        table.cell(statsTable, 0, 6, "Cumulative Î”:",
             text_color=color.new(#ffffff, 40),
             text_size=size.small,
             text_halign=text.align_left)
        cumDeltaColor = cumulativeDelta > 0 ? color.new(#00ff00, 0) : color.new(#ff0000, 0)
        cumDeltaSign = cumulativeDelta > 0 ? "+" : ""
        cumDeltaStr = str.tostring(math.round(cumulativeDelta))
        table.cell(statsTable, 1, 6, cumDeltaSign + cumDeltaStr,
             text_color=cumDeltaColor,
             text_size=size.normal,
             text_halign=text.align_right)

        // Pressure Strength
        table.cell(statsTable, 0, 7, "Pressure:",
             text_color=color.new(#ffffff, 40),
             text_size=size.small,
             text_halign=text.align_left)
        table.cell(statsTable, 1, 7, strength,
             text_color=pressureColor,
             text_size=size.small,
             text_halign=text.align_right)

// ============================================================================
// CRITICAL SIGNALS - AUTO LABELS
// ============================================================================

// Very strong buying (>75% buy volume)
if buyPercent > 75 and barstate.isconfirmed
    label.new(bar_index, low, "â¬† " + str.tostring(math.round(buyPercent)) + "%",
         style=label.style_label_up,
         color=color.new(#00ff00, 0),
         textcolor=color.white,
         size=size.small,
         tooltip="Very Strong Buying Pressure\nBuy: " + str.tostring(math.round(buyPercent, 1)) + "%\nSell: " + str.tostring(math.round(sellPercent, 1)) + "%")

// Very strong selling (>75% sell volume)
if sellPercent > 75 and barstate.isconfirmed
    label.new(bar_index, high, "â¬‡ " + str.tostring(math.round(sellPercent)) + "%",
         style=label.style_label_down,
         color=color.new(#ff0000, 0),
         textcolor=color.white,
         size=size.small,
         tooltip="Very Strong Selling Pressure\nBuy: " + str.tostring(math.round(buyPercent, 1)) + "%\nSell: " + str.tostring(math.round(sellPercent, 1)) + "%")

// Divergence detection (price vs cumulative delta)
priceTrend = close - close[20]
cumDeltaTrend = cumulativeDelta - cumulativeDelta[20]

bullishDivergence = priceTrend < 0 and cumDeltaTrend > 0 and barstate.isconfirmed
bearishDivergence = priceTrend > 0 and cumDeltaTrend < 0 and barstate.isconfirmed

if bullishDivergence
    label.new(bar_index, low, "ðŸ“ˆ DIV",
         style=label.style_label_up,
         color=color.new(#2196f3, 0),
         textcolor=color.white,
         size=size.tiny,
         tooltip="Bullish Divergence\nPrice falling but buying increasing")

if bearishDivergence
    label.new(bar_index, high, "ðŸ“‰ DIV",
         style=label.style_label_down,
         color=color.new(#ff9800, 0),
         textcolor=color.white,
         size=size.tiny,
         tooltip="Bearish Divergence\nPrice rising but selling increasing")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buyPercent > 75,
     title="Very Strong Buy Pressure",
     message="ðŸŸ¢ VERY STRONG BUYING on {{ticker}}: {{plot_0}}%")

alertcondition(sellPercent > 75,
     title="Very Strong Sell Pressure",
     message="ðŸ”´ VERY STRONG SELLING on {{ticker}}: {{plot_0}}%")

alertcondition(bullishDivergence,
     title="Bullish Divergence",
     message="ðŸ“ˆ Bullish Divergence on {{ticker}}: Price down but buying up")

alertcondition(bearishDivergence,
     title="Bearish Divergence",
     message="ðŸ“‰ Bearish Divergence on {{ticker}}: Price up but selling up")

// ============================================================================
// PLOT FOR ALERTS/EXTERNAL USE
// ============================================================================

plot(buyPercent, "Buy Percent", display=display.data_window)
plot(sellPercent, "Sell Percent", display=display.data_window)
plot(deltaPercent, "Delta Percent", display=display.data_window)
plot(cumulativeDelta, "Cumulative Delta", display=display.data_window)
