// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © YourTradingBot - Deep Pressure Charts with Multi-Period Analysis

//@version=5
indicator("Deep Pressure Charts", shorttitle="Deep Pressure", overlay=true, max_bars_back=500, max_boxes_count=500, max_labels_count=100)

// ============================================================================
// SETTINGS
// ============================================================================

showPressureBars = input.bool(true, "Show Pressure Zones Inside Candles", group="Display")
showSignificantOnly = input.bool(true, "Only Mark Strong Imbalances (>70%)", group="Display")
significanceThreshold = input.int(70, "Imbalance Threshold %", minval=60, maxval=90, group="Display")
showStats = input.bool(true, "Show Statistics Panel", group="Display")

buyColor = input.color(color.new(#00ff00, 30), "Buy Pressure Color", group="Colors")
sellColor = input.color(color.new(#ff0000, 30), "Sell Pressure Color", group="Colors")

// ============================================================================
// PRESSURE CALCULATION - ACCURATE ALGORITHM
// ============================================================================

calculatePressure() =>
    float buyVol = 0.0
    float sellVol = 0.0

    _range = high - low

    if _range == 0
        // Flat candle - split 50/50
        buyVol := volume / 2
        sellVol := volume / 2
    else
        // Factor 1: Where did price close in the range? (50% weight)
        closePosition = (close - low) / _range

        // Factor 2: Body size and direction (25% weight)
        bodySize = math.abs(close - open)
        bodyPercent = bodySize / _range
        isBullish = close > open
        isBearish = close < open

        // Factor 3: Wick analysis (25% weight)
        upperWick = high - math.max(open, close)
        lowerWick = math.min(open, close) - low
        upperWickPercent = upperWick / _range
        lowerWickPercent = lowerWick / _range

        // Calculate pressure score (0 = all selling, 1 = all buying)
        float score = 0.5

        // Apply Factor 1: Close position
        score := score + ((closePosition - 0.5) * 0.50)

        // Apply Factor 2: Body direction
        if isBullish
            score := score + (bodyPercent * 0.25)
        else if isBearish
            score := score - (bodyPercent * 0.25)

        // Apply Factor 3: Wick rejection
        wickPressure = lowerWickPercent - upperWickPercent
        score := score + (wickPressure * 0.25)

        // Clamp to valid range
        score := math.max(0, math.min(1, score))

        // Split volume by pressure score
        buyVol := volume * score
        sellVol := volume * (1 - score)

    [buyVol, sellVol]

// Calculate current bar pressure
[buyVolume, sellVolume] = calculatePressure()

// Calculate percentages
buyPercent = volume > 0 ? (buyVolume / volume) * 100 : 50
sellPercent = volume > 0 ? (sellVolume / volume) * 100 : 50
delta = buyVolume - sellVolume
deltaPercent = volume > 0 ? (delta / volume) * 100 : 0

// ============================================================================
// MULTI-PERIOD PRESSURE ANALYSIS
// ============================================================================

// Function to calculate average pressure over N bars
calcAveragePressure(lookback) =>
    float totalBuyVol = 0.0
    float totalSellVol = 0.0
    float totalVol = 0.0

    for i = 0 to lookback - 1
        if bar_index - i >= 0
            // Recalculate pressure for each historical bar
            _range = high[i] - low[i]
            _vol = volume[i]

            if _range > 0 and _vol > 0
                closePos = (close[i] - low[i]) / _range
                bodySize = math.abs(close[i] - open[i])
                bodyPct = bodySize / _range
                isBull = close[i] > open[i]
                isBear = close[i] < open[i]

                upperW = high[i] - math.max(open[i], close[i])
                lowerW = math.min(open[i], close[i]) - low[i]
                upperWPct = upperW / _range
                lowerWPct = lowerW / _range

                float sc = 0.5
                sc := sc + ((closePos - 0.5) * 0.50)
                if isBull
                    sc := sc + (bodyPct * 0.25)
                else if isBear
                    sc := sc - (bodyPct * 0.25)
                wickP = lowerWPct - upperWPct
                sc := sc + (wickP * 0.25)
                sc := math.max(0, math.min(1, sc))

                totalBuyVol := totalBuyVol + (_vol * sc)
                totalSellVol := totalSellVol + (_vol * (1 - sc))
                totalVol := totalVol + _vol

    buyPct = totalVol > 0 ? (totalBuyVol / totalVol) * 100 : 50
    sellPct = totalVol > 0 ? (totalSellVol / totalVol) * 100 : 50

    [buyPct, sellPct]

// Last 5 candles pressure
[buy5, sell5] = calcAveragePressure(5)

// Last 15 candles pressure
[buy15, sell15] = calcAveragePressure(15)

// Daily bias - calculate from start of day
var float dailyBuyVol = 0.0
var float dailySellVol = 0.0
var float dailyTotalVol = 0.0

// Reset at start of new day
isNewDay = ta.change(dayofweek) != 0 or (bar_index == 0)
if isNewDay
    dailyBuyVol := 0.0
    dailySellVol := 0.0
    dailyTotalVol := 0.0

// Accumulate throughout the day
dailyBuyVol := dailyBuyVol + buyVolume
dailySellVol := dailySellVol + sellVolume
dailyTotalVol := dailyTotalVol + volume

// Calculate daily percentages
dailyBuyPercent = dailyTotalVol > 0 ? (dailyBuyVol / dailyTotalVol) * 100 : 50
dailySellPercent = dailyTotalVol > 0 ? (dailySellVol / dailyTotalVol) * 100 : 50

// Determine bias
dailyBias = dailyBuyPercent > 55 ? "BULLISH" : dailySellPercent > 55 ? "BEARISH" : "NEUTRAL"

// ============================================================================
// VISUAL: PRESSURE ZONES INSIDE CANDLES
// ============================================================================

// Create pressure zones using boxes (must be at root level)
var box buyBox = na
var box sellBox = na

if showPressureBars and barstate.isconfirmed
    rangeSize = high - low

    if rangeSize > 0
        // Buy pressure (green from bottom up)
        buyHeight = rangeSize * (buyVolume / volume)
        buyTop = low + buyHeight

        buyBox := box.new(bar_index, buyTop, bar_index + 1, low, bgcolor=buyColor, border_color=na, border_width=0)

        // Sell pressure (red from top down)
        sellHeight = rangeSize * (sellVolume / volume)
        sellBottom = high - sellHeight

        sellBox := box.new(bar_index, high, bar_index + 1, sellBottom, bgcolor=sellColor, border_color=na, border_width=0)

// ============================================================================
// CANDLE COLORING
// ============================================================================

getCandleColor() =>
    if buyPercent > 75
        color.new(#00ff00, 0)
    else if buyPercent > 65
        color.new(#00ff00, 50)
    else if buyPercent > 55
        color.new(#00ff00, 80)
    else if sellPercent > 75
        color.new(#ff0000, 0)
    else if sellPercent > 65
        color.new(#ff0000, 50)
    else if sellPercent > 55
        color.new(#ff0000, 80)
    else
        color.new(#808080, 70)

candleColor = showPressureBars ? color.new(#808080, 95) : getCandleColor()
wickColor = showPressureBars ? color.new(#808080, 80) : getCandleColor()

plotcandle(open, high, low, close, title="Candles", color=candleColor, wickcolor=wickColor, bordercolor=candleColor)

// ============================================================================
// LABELS FOR SIGNIFICANT PRESSURE
// ============================================================================

shouldLabel = showSignificantOnly ? (buyPercent > significanceThreshold or sellPercent > significanceThreshold) : false

if shouldLabel and barstate.isconfirmed
    if buyPercent > significanceThreshold
        label.new(bar_index, low, "▲", style=label.style_none, color=color.new(color.white, 100), textcolor=color.new(#00ff00, 0), size=size.normal, yloc=yloc.belowbar)

    if sellPercent > significanceThreshold
        label.new(bar_index, high, "▼", style=label.style_none, color=color.new(color.white, 100), textcolor=color.new(#ff0000, 0), size=size.normal, yloc=yloc.abovebar)

// ============================================================================
// STATISTICS PANEL - MULTI-PERIOD ANALYSIS
// ============================================================================

if showStats
    var table statsTable = table.new(position.top_right, 2, 11, bgcolor=color.new(#000000, 10), border_width=2, border_color=color.new(#333333, 40), frame_width=1, frame_color=color.new(#555555, 40))

    if barstate.islast
        // Title
        table.cell(statsTable, 0, 0, "PRESSURE ANALYSIS", text_color=color.white, text_size=size.normal, bgcolor=color.new(#1976d2, 20), text_halign=text.align_center)
        table.merge_cells(statsTable, 0, 0, 1, 0)

        // Current Candle
        table.cell(statsTable, 0, 1, "CURRENT", text_color=color.new(#ffffff, 40), text_size=size.small, bgcolor=color.new(#424242, 50))
        table.merge_cells(statsTable, 0, 1, 1, 1)

        table.cell(statsTable, 0, 2, "Buy", text_color=color.new(#ffffff, 50), text_size=size.small)
        table.cell(statsTable, 1, 2, str.tostring(math.round(buyPercent, 1)) + "%", text_color=buyColor, text_size=size.normal, text_halign=text.align_right)

        table.cell(statsTable, 0, 3, "Sell", text_color=color.new(#ffffff, 50), text_size=size.small)
        table.cell(statsTable, 1, 3, str.tostring(math.round(sellPercent, 1)) + "%", text_color=sellColor, text_size=size.normal, text_halign=text.align_right)

        // Last 5 Candles
        table.cell(statsTable, 0, 4, "LAST 5 CANDLES", text_color=color.new(#ffffff, 40), text_size=size.small, bgcolor=color.new(#424242, 50))
        table.merge_cells(statsTable, 0, 4, 1, 4)

        table.cell(statsTable, 0, 5, "Buy", text_color=color.new(#ffffff, 50), text_size=size.small)
        table.cell(statsTable, 1, 5, str.tostring(math.round(buy5, 1)) + "%", text_color=buyColor, text_size=size.normal, text_halign=text.align_right)

        table.cell(statsTable, 0, 6, "Sell", text_color=color.new(#ffffff, 50), text_size=size.small)
        table.cell(statsTable, 1, 6, str.tostring(math.round(sell5, 1)) + "%", text_color=sellColor, text_size=size.normal, text_halign=text.align_right)

        // Last 15 Candles
        table.cell(statsTable, 0, 7, "LAST 15 CANDLES", text_color=color.new(#ffffff, 40), text_size=size.small, bgcolor=color.new(#424242, 50))
        table.merge_cells(statsTable, 0, 7, 1, 7)

        table.cell(statsTable, 0, 8, "Buy", text_color=color.new(#ffffff, 50), text_size=size.small)
        table.cell(statsTable, 1, 8, str.tostring(math.round(buy15, 1)) + "%", text_color=buyColor, text_size=size.normal, text_halign=text.align_right)

        table.cell(statsTable, 0, 9, "Sell", text_color=color.new(#ffffff, 50), text_size=size.small)
        table.cell(statsTable, 1, 9, str.tostring(math.round(sell15, 1)) + "%", text_color=sellColor, text_size=size.normal, text_halign=text.align_right)

        // Daily Bias
        table.cell(statsTable, 0, 10, "DAILY BIAS: " + dailyBias, text_color=dailyBias == "BULLISH" ? buyColor : dailyBias == "BEARISH" ? sellColor : color.gray, text_size=size.small, bgcolor=color.new(#424242, 50), text_halign=text.align_center)
        table.merge_cells(statsTable, 0, 10, 1, 10)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buyPercent > significanceThreshold, "Strong Buy Pressure", "Strong buying ({{plot_0}}%) on {{ticker}}")
alertcondition(sellPercent > significanceThreshold, "Strong Sell Pressure", "Strong selling ({{plot_0}}%) on {{ticker}}")

// ============================================================================
// PLOT OUTPUTS
// ============================================================================

plot(buyPercent, "Buy%", display = display.data_window)
plot(sellPercent, "Sell%", display = display.data_window)
plot(buy5, "Buy5avg", display = display.data_window)
plot(sell5, "Sell5avg", display = display.data_window)
plot(buy15, "Buy15avg", display = display.data_window)
plot(sell15, "Sell15avg", display = display.data_window)
