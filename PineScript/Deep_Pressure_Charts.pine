// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YourTradingBot - Deep Pressure Charts with Multi-Period Analysis

//@version=6
indicator("Deep Pressure Charts", shorttitle="Pressure", overlay=true, max_bars_back=500)

// ============================================================================
// SETTINGS
// ============================================================================

buyColor = input.color(color.new(#00ff00, 30), "Buy Pressure Color", group="Colors")
sellColor = input.color(color.new(#ff0000, 30), "Sell Pressure Color", group="Colors")

// ============================================================================
// PRESSURE CALCULATION - ACCURATE ALGORITHM
// ============================================================================

calculatePressure() =>
    float buyVol = 0.0
    float sellVol = 0.0

    _range = high - low

    if _range == 0
        // Flat candle - split 50/50
        buyVol := volume / 2
        sellVol := volume / 2
    else
        // Factor 1: Where did price close in the range? (50% weight)
        closePosition = (close - low) / _range

        // Factor 2: Body size and direction (25% weight)
        bodySize = math.abs(close - open)
        bodyPercent = bodySize / _range
        isBullish = close > open
        isBearish = close < open

        // Factor 3: Wick analysis (25% weight)
        upperWick = high - math.max(open, close)
        lowerWick = math.min(open, close) - low
        upperWickPercent = upperWick / _range
        lowerWickPercent = lowerWick / _range

        // Calculate pressure score (0 = all selling, 1 = all buying)
        float score = 0.5

        // Apply Factor 1: Close position
        score := score + ((closePosition - 0.5) * 0.50)

        // Apply Factor 2: Body direction
        if isBullish
            score := score + (bodyPercent * 0.25)
        else if isBearish
            score := score - (bodyPercent * 0.25)

        // Apply Factor 3: Wick rejection
        wickPressure = lowerWickPercent - upperWickPercent
        score := score + (wickPressure * 0.25)

        // Clamp to valid range
        score := math.max(0, math.min(1, score))

        // Split volume by pressure score
        buyVol := volume * score
        sellVol := volume * (1 - score)

    [buyVol, sellVol]

// Calculate current bar pressure
[buyVolume, sellVolume] = calculatePressure()

// Calculate percentages
buyPercent = volume > 0 ? (buyVolume / volume) * 100 : 50
sellPercent = volume > 0 ? (sellVolume / volume) * 100 : 50
delta = buyVolume - sellVolume
deltaPercent = volume > 0 ? (delta / volume) * 100 : 0

// ============================================================================
// MULTI-PERIOD PRESSURE ANALYSIS
// ============================================================================

// Function to calculate average pressure over N bars
calcAveragePressure(lookback) =>
    float totalBuyVol = 0.0
    float totalSellVol = 0.0
    float totalVol = 0.0

    for i = 0 to lookback - 1
        if bar_index - i >= 0
            // Recalculate pressure for each historical bar
            _range = high[i] - low[i]
            _vol = volume[i]

            if _range > 0 and _vol > 0
                closePos = (close[i] - low[i]) / _range
                bodySize = math.abs(close[i] - open[i])
                bodyPct = bodySize / _range
                isBull = close[i] > open[i]
                isBear = close[i] < open[i]

                upperW = high[i] - math.max(open[i], close[i])
                lowerW = math.min(open[i], close[i]) - low[i]
                upperWPct = upperW / _range
                lowerWPct = lowerW / _range

                float sc = 0.5
                sc := sc + ((closePos - 0.5) * 0.50)
                if isBull
                    sc := sc + (bodyPct * 0.25)
                else if isBear
                    sc := sc - (bodyPct * 0.25)
                wickP = lowerWPct - upperWPct
                sc := sc + (wickP * 0.25)
                sc := math.max(0, math.min(1, sc))

                totalBuyVol := totalBuyVol + (_vol * sc)
                totalSellVol := totalSellVol + (_vol * (1 - sc))
                totalVol := totalVol + _vol

    buyPct = totalVol > 0 ? (totalBuyVol / totalVol) * 100 : 50
    sellPct = totalVol > 0 ? (totalSellVol / totalVol) * 100 : 50

    [buyPct, sellPct]

// Last 5 candles pressure
[buy5, sell5] = calcAveragePressure(5)

// Last 15 candles pressure
[buy15, sell15] = calcAveragePressure(15)

// Daily bias - calculate from start of day
var float dailyBuyVol = 0.0
var float dailySellVol = 0.0
var float dailyTotalVol = 0.0

// Reset at start of new day
isNewDay = ta.change(dayofweek) != 0 or (bar_index == 0)
if isNewDay
    dailyBuyVol := 0.0
    dailySellVol := 0.0
    dailyTotalVol := 0.0

// Accumulate throughout the day
dailyBuyVol := dailyBuyVol + buyVolume
dailySellVol := dailySellVol + sellVolume
dailyTotalVol := dailyTotalVol + volume

// Calculate daily percentages
dailyBuyPercent = dailyTotalVol > 0 ? (dailyBuyVol / dailyTotalVol) * 100 : 50
dailySellPercent = dailyTotalVol > 0 ? (dailySellVol / dailyTotalVol) * 100 : 50

// Determine bias
dailyBias = dailyBuyPercent > 55 ? "BULLISH" : dailySellPercent > 55 ? "BEARISH" : "NEUTRAL"

// No visual overlays - dashboard only

// ============================================================================
// STATISTICS PANEL - HORIZONTAL LAYOUT TOP CENTER
// ============================================================================

var table statsTable = table.new(position.top_center, 5, 3, bgcolor=color.new(#000000, 15), border_width=1, border_color=color.new(#333333, 50), frame_width=1, frame_color=color.new(#555555, 50))

if barstate.islast
    // Row 0: Headers
    table.cell(statsTable, 0, 0, "PRESSURE", text_color=color.white, text_size=size.tiny, bgcolor=color.new(#1976d2, 30), text_halign=text.align_center)
    table.cell(statsTable, 1, 0, "NOW", text_color=color.white, text_size=size.tiny, bgcolor=color.new(#424242, 60), text_halign=text.align_center)
    table.cell(statsTable, 2, 0, "5 BARS", text_color=color.white, text_size=size.tiny, bgcolor=color.new(#424242, 60), text_halign=text.align_center)
    table.cell(statsTable, 3, 0, "15 BARS", text_color=color.white, text_size=size.tiny, bgcolor=color.new(#424242, 60), text_halign=text.align_center)
    table.cell(statsTable, 4, 0, "DAY", text_color=color.white, text_size=size.tiny, bgcolor=color.new(#424242, 60), text_halign=text.align_center)

    // Row 1: Buy percentages
    table.cell(statsTable, 0, 1, "Buy", text_color=color.new(#ffffff, 50), text_size=size.tiny)
    table.cell(statsTable, 1, 1, str.tostring(math.round(buyPercent, 1)) + "%", text_color=buyColor, text_size=size.small, text_halign=text.align_center)
    table.cell(statsTable, 2, 1, str.tostring(math.round(buy5, 1)) + "%", text_color=buyColor, text_size=size.small, text_halign=text.align_center)
    table.cell(statsTable, 3, 1, str.tostring(math.round(buy15, 1)) + "%", text_color=buyColor, text_size=size.small, text_halign=text.align_center)
    table.cell(statsTable, 4, 1, dailyBias, text_color=dailyBias == "BULLISH" ? buyColor : dailyBias == "BEARISH" ? sellColor : color.gray, text_size=size.tiny, text_halign=text.align_center)

    // Row 2: Sell percentages
    table.cell(statsTable, 0, 2, "Sell", text_color=color.new(#ffffff, 50), text_size=size.tiny)
    table.cell(statsTable, 1, 2, str.tostring(math.round(sellPercent, 1)) + "%", text_color=sellColor, text_size=size.small, text_halign=text.align_center)
    table.cell(statsTable, 2, 2, str.tostring(math.round(sell5, 1)) + "%", text_color=sellColor, text_size=size.small, text_halign=text.align_center)
    table.cell(statsTable, 3, 2, str.tostring(math.round(sell15, 1)) + "%", text_color=sellColor, text_size=size.small, text_halign=text.align_center)
    table.cell(statsTable, 4, 2, "", text_color=color.gray, text_size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buyPercent > 70, "Strong Buy Pressure", "Strong buying on {{ticker}}")
alertcondition(sellPercent > 70, "Strong Sell Pressure", "Strong selling on {{ticker}}")

// ============================================================================
// PLOT OUTPUTS
// ============================================================================

plot(buyPercent, "Buy%", display = display.data_window)
plot(sellPercent, "Sell%", display = display.data_window)
plot(buy5, "Buy5avg", display = display.data_window)
plot(sell5, "Sell5avg", display = display.data_window)
plot(buy15, "Buy15avg", display = display.data_window)
plot(sell15, "Sell15avg", display = display.data_window)
